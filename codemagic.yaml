workflows:
  ios-workflow-react-native:
    name: iOS Build com React Native
    instance_type: mac_mini_m1
    environment:
      node: 18
      xcode: latest
    scripts:
      - name: Install npm dependencies
        script: |
          echo "üì¶ Instalando depend√™ncias npm..."
          npm install
          
      - name: Install CocoaPods dependencies
        script: |
          cd ios
          
          echo "üì¶ Instalando CocoaPods..."
          
          # Instalar CocoaPods se n√£o estiver instalado
          if ! command -v pod &> /dev/null; then
            echo "Instalando CocoaPods..."
            gem install cocoapods
          fi
          
          # Executar pod install
          pod install --verbose
          
          echo "‚úÖ CocoaPods instalado com sucesso!"
          
      - name: Verificar estrutura ap√≥s pod install
        script: |
          cd ios
          
          echo "üîç Verificando estrutura ap√≥s pod install..."
          
          # Verificar se workspace foi criado
          if [ -f "modamaskavo.xcworkspace/contents.xcworkspacedata" ]; then
            echo "‚úÖ Workspace criado com sucesso!"
          else
            echo "‚ùå Workspace n√£o foi criado!"
            exit 1
          fi
          
          # Verificar se Pods foram instalados
          if [ -d "Pods" ]; then
            echo "‚úÖ Pasta Pods criada!"
            echo "üìÅ Pods instalados:"
            ls -la Pods/ | head -10
          else
            echo "‚ùå Pasta Pods n√£o encontrada!"
            exit 1
          fi
          
          # Verificar se React foi instalado
          if [ -d "Pods/React-Core" ] || [ -d "Pods/React" ]; then
            echo "‚úÖ React encontrado nos Pods!"
          else
            echo "‚ùå React n√£o encontrado nos Pods!"
            echo "üìÅ Pods dispon√≠veis:"
            ls -la Pods/ | grep -i react || echo "Nenhum pod React encontrado"
          fi
          
      - name: Build iOS com workspace
        script: |
          cd ios
          
          mkdir -p build
          
          echo "üî® Iniciando build com workspace..."
          
          # Build usando WORKSPACE (n√£o project) para React Native
          xcodebuild -workspace modamaskavo.xcworkspace \
                     -scheme modamaskavo \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath build/modamaskavo.xcarchive \
                     archive \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     SKIP_INSTALL=NO \
                     ONLY_ACTIVE_ARCH=NO \
                     -allowProvisioningUpdates \
                     2>&1 | tee build-success.log
          
          BUILD_RESULT=$?
          
          echo ""
          echo "üìä Resultado do build: $BUILD_RESULT"
          
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "‚úÖ BUILD SUCESSO!"
            
            # Verificar se archive foi criado
            if [ -d "build/modamaskavo.xcarchive" ]; then
              echo "‚úÖ Archive criado com sucesso!"
              
              # Mostrar tamanho do archive
              ARCHIVE_SIZE=$(du -sh build/modamaskavo.xcarchive | cut -f1)
              echo "üìä Tamanho do archive: $ARCHIVE_SIZE"
              
              # Procurar por .app
              echo "üì± Procurando .app no archive:"
              find build/modamaskavo.xcarchive -name "*.app" -type d -exec ls -lah {} \;
              
            else
              echo "‚ùå Archive n√£o foi criado!"
            fi
          else
            echo "‚ùå Build falhou!"
            echo "üîç √öltimas linhas do erro:"
            tail -50 build-success.log
          fi
          
      - name: Criar IPA do archive
        script: |
          cd ios
          
          echo "üì¶ Criando IPA do archive..."
          
          # Verificar se archive existe
          if [ -d "build/modamaskavo.xcarchive" ]; then
            echo "‚úÖ Archive encontrado!"
            
            # Procurar por .app no archive
            APP_PATH=$(find build/modamaskavo.xcarchive -name "*.app" -type d | head -1)
            
            if [ -n "$APP_PATH" ]; then
              echo "üì± App encontrado: $APP_PATH"
              
              # Verificar tamanho do app
              APP_SIZE=$(du -sh "$APP_PATH" | cut -f1)
              FILE_COUNT=$(find "$APP_PATH" -type f | wc -l)
              
              echo "üìä Tamanho do app: $APP_SIZE"
              echo "üìÑ N√∫mero de arquivos: $FILE_COUNT"
              
              # Listar alguns arquivos para verificar se est√° completo
              echo "üìÑ Alguns arquivos do app:"
              find "$APP_PATH" -type f | head -10
              
              # Criar IPA
              cd build
              
              # Copiar .app
              cp -r "$APP_PATH" ./modamaskavo.app
              
              # Criar estrutura IPA
              mkdir -p Payload
              cp -r modamaskavo.app Payload/
              
              # Criar ZIP/IPA
              zip -r modamaskavo.ipa Payload/
              
              # Verificar IPA criado
              if [ -f "modamaskavo.ipa" ]; then
                IPA_SIZE=$(du -sh modamaskavo.ipa | cut -f1)
                IPA_BYTES=$(wc -c < modamaskavo.ipa)
                
                echo "‚úÖ IPA criado com sucesso!"
                echo "üìä Tamanho do IPA: $IPA_SIZE ($IPA_BYTES bytes)"
                
                # Copiar para raiz
                cp modamaskavo.ipa ../../modamaskavo-react-native.ipa
                
                if [ $IPA_BYTES -gt 5000000 ]; then  # Maior que 5MB
                  echo "üéâ IPA parece v√°lido para React Native!"
                else
                  echo "‚ö†Ô∏è  IPA ainda pequeno para React Native"
                fi
                
                # Verificar conte√∫do do IPA
                echo "üìÑ Verificando conte√∫do do IPA:"
                unzip -l modamaskavo.ipa | head -20
                
              else
                echo "‚ùå Falha ao criar IPA!"
              fi
            else
              echo "‚ùå Nenhum .app encontrado no archive!"
            fi
          else
            echo "‚ùå Archive n√£o existe!"
          fi
          
      - name: Relat√≥rio final
        script: |
          echo "üìã RELAT√ìRIO FINAL"
          echo "=================="
          
          # Verificar IPAs criados
          echo "üì± IPAs encontrados:"
          find . -name "*.ipa" -exec ls -lh {} \;
          
          # Verificar se build foi bem-sucedido
          if [ -f "ios/build-success.log" ]; then
            echo ""
            echo "üìä Status do build:"
            if grep -q "BUILD SUCCEEDED" ios/build-success.log; then
              echo "‚úÖ Build bem-sucedido!"
            else
              echo "‚ùå Build falhou"
            fi
          fi
          
          # Verificar se CocoaPods funcionou
          echo ""
          echo "üìä Status CocoaPods:"
          if [ -f "ios/Podfile.lock" ]; then
            echo "‚úÖ Podfile.lock encontrado"
          else
            echo "‚ùå Podfile.lock n√£o encontrado"
          fi
          
          if [ -d "ios/Pods" ]; then
            echo "‚úÖ Pods instalados"
          else
            echo "‚ùå Pods n√£o instalados"
          fi
          
    artifacts:
      - ios/build/*.ipa
      - ios/build/*.app
      - ios/build/*.xcarchive
      - ios/build-success.log
      - ios/Podfile.lock
      - "*.ipa"
