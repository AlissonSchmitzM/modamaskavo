workflows:
  ios-workflow-debug:
    name: iOS Build com DiagnÃ³stico Completo
    instance_type: mac_mini_m1
    environment:
      node: 18
      xcode: latest
    scripts:
      - name: Install npm dependencies
        script: |
          npm install --production
          
      - name: Criar estrutura CocoaPods
        script: |
          cd ios
          
          echo "ðŸ”§ Criando estrutura CocoaPods..."
          
          # Criar todas as pastas necessÃ¡rias
          mkdir -p "Pods/Target Support Files/Pods-modamaskavo"
          mkdir -p "Target Support Files/Pods-modamaskavo"
          
          # Criar arquivo xcconfig
          cat > "Pods/Target Support Files/Pods-modamaskavo/Pods-modamaskavo.release.xcconfig" << 'EOF'
          CLANG_ENABLE_OBJC_ARC = YES
          IPHONEOS_DEPLOYMENT_TARGET = 11.0
          OTHER_LDFLAGS = 
          PODS_BUILD_DIR = ${BUILD_DIR}
          PODS_CONFIGURATION_BUILD_DIR = ${PODS_BUILD_DIR}/$(CONFIGURATION)$(EFFECTIVE_PLATFORM_NAME)
          PODS_PODFILE_DIR_PATH = ${SRCROOT}/.
          PODS_ROOT = ${SRCROOT}/Pods
          EOF
          
          cp "Pods/Target Support Files/Pods-modamaskavo/Pods-modamaskavo.release.xcconfig" "Target Support Files/Pods-modamaskavo/"
          
          # Criar arquivos xcfilelist COMPLETAMENTE VAZIOS
          touch "Pods/Target Support Files/Pods-modamaskavo/Pods-modamaskavo-frameworks-Release-input-files.xcfilelist"
          touch "Pods/Target Support Files/Pods-modamaskavo/Pods-modamaskavo-frameworks-Release-output-files.xcfilelist"
          touch "Pods/Target Support Files/Pods-modamaskavo/Pods-modamaskavo-resources-Release-input-files.xcfilelist"
          touch "Pods/Target Support Files/Pods-modamaskavo/Pods-modamaskavo-resources-Release-output-files.xcfilelist"
          
          cp "Pods/Target Support Files/Pods-modamaskavo/"*.xcfilelist "Target Support Files/Pods-modamaskavo/"
          
          # Scripts vazios
          cat > "Pods/Target Support Files/Pods-modamaskavo/Pods-modamaskavo-frameworks.sh" << 'EOF'
          #!/bin/sh
          echo "CocoaPods frameworks script vazio"
          exit 0
          EOF
          
          cat > "Pods/Target Support Files/Pods-modamaskavo/Pods-modamaskavo-resources.sh" << 'EOF'
          #!/bin/sh
          echo "CocoaPods resources script vazio"
          exit 0
          EOF
          
          chmod +x "Pods/Target Support Files/Pods-modamaskavo/"*.sh
          cp "Pods/Target Support Files/Pods-modamaskavo/"*.sh "Target Support Files/Pods-modamaskavo/"
          
          echo "âœ… Estrutura CocoaPods criada!"
          
      - name: Verificar projeto antes do build
        script: |
          cd ios
          
          echo "ðŸ” Verificando estrutura do projeto..."
          
          # Verificar se o projeto existe
          if [ -f "modamaskavo.xcodeproj/project.pbxproj" ]; then
            echo "âœ… Projeto Xcode encontrado"
          else
            echo "âŒ Projeto Xcode nÃ£o encontrado!"
            ls -la
          fi
          
          # Verificar schemes disponÃ­veis
          echo "ðŸ“‹ Schemes disponÃ­veis:"
          xcodebuild -project modamaskavo.xcodeproj -list
          
          # Verificar configuraÃ§Ãµes
          echo "ðŸ“‹ ConfiguraÃ§Ãµes disponÃ­veis:"
          xcodebuild -project modamaskavo.xcodeproj -showBuildSettings -configuration Release | head -20
          
      - name: Build com diagnÃ³stico detalhado
        script: |
          cd ios
          
          mkdir -p build
          
          echo "ðŸ”¨ Iniciando build com diagnÃ³stico completo..."
          
          # Build SEM -quiet para ver todos os erros
          xcodebuild -project modamaskavo.xcodeproj \
                     -scheme modamaskavo \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath build/modamaskavo.xcarchive \
                     archive \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     SKIP_INSTALL=NO \
                     ONLY_ACTIVE_ARCH=NO \
                     -allowProvisioningUpdates \
                     -verbose
          
          BUILD_RESULT=$?
          
          echo "ðŸ“Š Resultado do build: $BUILD_RESULT"
          
          # Verificar o que foi gerado independente do resultado
          echo "ðŸ“ ConteÃºdo da pasta build:"
          if [ -d "build" ]; then
            find build -type f -exec ls -lh {} \; | head -30
          fi
          
          # Verificar se archive foi criado
          if [ -d "build/modamaskavo.xcarchive" ]; then
            echo "âœ… Archive criado!"
            
            # Mostrar estrutura do archive
            echo "ðŸ“ Estrutura do archive:"
            find build/modamaskavo.xcarchive -type f -name "*.app" -exec ls -lh {} \;
            
            # Verificar conteÃºdo do archive
            echo "ðŸ“± Procurando .app no archive:"
            find build/modamaskavo.xcarchive -name "*.app" -type d
          else
            echo "âŒ Archive nÃ£o foi criado!"
          fi
          
      - name: AnÃ¡lise detalhada do .app
        script: |
          cd ios
          
          echo "ðŸ” Analisando arquivos .app gerados..."
          
          # Procurar por TODOS os .app
          ALL_APPS=$(find . -name "*.app" -type d 2>/dev/null)
          
          if [ -n "$ALL_APPS" ]; then
            echo "ðŸ“± Todos os .app encontrados:"
            echo "$ALL_APPS"
            
            # Analisar cada .app
            for app_path in $ALL_APPS; do
              echo ""
              echo "ðŸ” Analisando: $app_path"
              echo "===================="
              
              # Tamanho do .app
              APP_SIZE=$(du -sh "$app_path" | cut -f1)
              echo "ðŸ“Š Tamanho: $APP_SIZE"
              
              # NÃºmero de arquivos
              FILE_COUNT=$(find "$app_path" -type f | wc -l)
              echo "ðŸ“„ Arquivos: $FILE_COUNT"
              
              # Listar conteÃºdo
              echo "ðŸ“„ ConteÃºdo:"
              ls -lah "$app_path" | head -10
              
              # Verificar se tem executÃ¡vel
              if [ -f "$app_path/modamaskavo" ]; then
                echo "âœ… ExecutÃ¡vel encontrado"
                ls -lh "$app_path/modamaskavo"
              else
                echo "âŒ ExecutÃ¡vel nÃ£o encontrado"
                echo "ðŸ“„ Arquivos no root do .app:"
                find "$app_path" -maxdepth 1 -type f
              fi
              
              # Verificar Info.plist
              if [ -f "$app_path/Info.plist" ]; then
                echo "âœ… Info.plist encontrado"
              else
                echo "âŒ Info.plist nÃ£o encontrado"
              fi
            done
          else
            echo "âŒ Nenhum .app encontrado!"
            
            # Procurar por arquivos de build alternativos
            echo "ðŸ” Procurando arquivos de build alternativos..."
            find . -name "*.o" -o -name "*.a" -o -name "*.dylib" | head -10
          fi
          
      - name: Criar IPA com validaÃ§Ã£o de tamanho
        script: |
          cd ios
          
          echo "ðŸ“¦ Criando IPA com validaÃ§Ã£o completa..."
          
          # Encontrar o melhor .app (maior tamanho)
          BEST_APP=""
          BEST_SIZE=0
          
          for app_path in $(find . -name "*.app" -type d 2>/dev/null); do
            APP_SIZE_BYTES=$(du -sb "$app_path" | cut -f1)
            
            if [ $APP_SIZE_BYTES -gt $BEST_SIZE ]; then
              BEST_APP="$app_path"
              BEST_SIZE=$APP_SIZE_BYTES
            fi
          done
          
          if [ -n "$BEST_APP" ] && [ $BEST_SIZE -gt 1000 ]; then
            echo "ðŸ“± Usando melhor .app: $BEST_APP"
            echo "ðŸ“Š Tamanho: $BEST_SIZE bytes"
            
            # Criar pasta build
            mkdir -p build
            cd build
            
            # Copiar .app
            cp -r "../$BEST_APP" ./modamaskavo.app
            
            # Verificar se a cÃ³pia foi bem-sucedida
            if [ -d "modamaskavo.app" ]; then
              COPY_SIZE=$(du -sb modamaskavo.app | cut -f1)
              echo "ðŸ“Š Tamanho da cÃ³pia: $COPY_SIZE bytes"
              
              # Criar estrutura do IPA
              mkdir -p Payload
              cp -r modamaskavo.app Payload/
              
              # Verificar Payload
              PAYLOAD_SIZE=$(du -sb Payload | cut -f1)
              echo "ðŸ“Š Tamanho do Payload: $PAYLOAD_SIZE bytes"
              
              # Criar IPA
              zip -r modamaskavo.ipa Payload/
              
              # Verificar IPA final
              if [ -f "modamaskavo.ipa" ]; then
                IPA_SIZE=$(du -sb modamaskavo.ipa | cut -f1)
                IPA_SIZE_MB=$(echo "scale=2; $IPA_SIZE / 1024 / 1024" | bc)
                
                echo "ðŸ“Š IPA criado!"
                echo "ðŸ“Š Tamanho: $IPA_SIZE bytes ($IPA_SIZE_MB MB)"
                
                if [ $IPA_SIZE -lt 100000 ]; then  # Menos de 100KB
                  echo "ðŸš¨ IPA muito pequeno! Verificando conteÃºdo..."
                  
                  # Verificar conteÃºdo do ZIP
                  echo "ðŸ“„ ConteÃºdo do IPA:"
                  unzip -l modamaskavo.ipa | head -20
                  
                  # Extrair e verificar
                  mkdir -p ipa_check
                  cd ipa_check
                  unzip -q ../modamaskavo.ipa
                  
                  if [ -d "Payload/modamaskavo.app" ]; then
                    echo "ðŸ“Š Tamanho do app extraÃ­do:"
                    du -sh Payload/modamaskavo.app
                    
                    echo "ðŸ“„ ConteÃºdo do app extraÃ­do:"
                    find Payload/modamaskavo.app -type f | head -10
                  fi
                  
                  cd ..
                else
                  echo "âœ… IPA parece ter tamanho normal!"
                fi
                
                # Copiar para raiz
                cp modamaskavo.ipa ../../modamaskavo-debug.ipa
                
              else
                echo "âŒ Falha ao criar IPA!"
              fi
            else
              echo "âŒ Falha ao copiar .app!"
            fi
            
          else
            echo "âŒ Nenhum .app vÃ¡lido encontrado!"
            echo "ðŸ“‹ Criando relatÃ³rio de falha..."
            
            # Criar relatÃ³rio detalhado
            cat > ../../build-failure-report.txt << EOF
            Build Failure Report
            ===================
            
            Data: $(date)
            
            Problema: Nenhum .app vÃ¡lido foi gerado
            
            Apps encontrados:
            $(find . -name "*.app" -type d 2>/dev/null | while read app; do
              echo "$app: $(du -sh "$app" | cut -f1)"
            done)
            
            PossÃ­veis causas:
            1. Erro de compilaÃ§Ã£o
            2. DependÃªncias faltando
            3. ConfiguraÃ§Ã£o incorreta do projeto
            4. Problemas com CocoaPods
            
            PrÃ³ximos passos:
            1. Verificar logs de build
            2. Verificar dependÃªncias
            3. Verificar configuraÃ§Ãµes do projeto
            EOF
            
            echo "ðŸ“„ RelatÃ³rio de falha criado!"
          fi
          
      - name: RelatÃ³rio final detalhado
        script: |
          echo "ðŸ“‹ RELATÃ“RIO FINAL DETALHADO"
          echo "============================"
          
          # Verificar todos os IPAs
          echo "ðŸ“± IPAs encontrados:"
          find . -name "*.ipa" -exec ls -lh {} \;
          
          # Verificar todos os .app
          echo ""
          echo "ðŸ“± Apps encontrados:"
          find . -name "*.app" -type d -exec du -sh {} \;
          
          # Verificar archives
          echo ""
          echo "ðŸ“¦ Archives encontrados:"
          find . -name "*.xcarchive" -type d -exec du -sh {} \;
          
          # Resumo final
          echo ""
          echo "ðŸ“Š RESUMO:"
          
          IPA_COUNT=$(find . -name "*.ipa" | wc -l)
          APP_COUNT=$(find . -name "*.app" -type d | wc -l)
          
          echo "- IPAs gerados: $IPA_COUNT"
          echo "- Apps gerados: $APP_COUNT"
          
          if [ $IPA_COUNT -gt 0 ]; then
            LARGEST_IPA=$(find . -name "*.ipa" -exec ls -l {} \; | sort -k5 -nr | head -1)
            echo "- Maior IPA: $LARGEST_IPA"
          fi
          
    artifacts:
      - ios/build/*.ipa
      - ios/build/*.app
      - ios/build/*.xcarchive
      - "*.ipa"
      - build-failure-report.txt
