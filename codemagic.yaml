# codemagic.yaml
# Este arquivo define o fluxo de build para o CodeMagic

workflows:
  ios-build:
    name: iOS Build
    instance_type: mac_mini_m1
    integrations:
      github:
        integration_id: NYzgXQlItsMW8Bb3kUrUKN4Ev3rwStaOBfuvFr4FwM0

    environment:
      node: 18.x
      ruby: 3.x
      groups:
        - apple_developer_portal_credentials
      vars:
        # Tenta usar .xcworkspace, se não encontrar, usa .xcodeproj
        XCODE_PROJECT_OR_WORKSPACE:
          - modamaskavo.xcworkspace
          - modamaskavo.xcodeproj
        XCODE_SCHEME: modamaskavo

    scripts:
      - name: Install npm dependencies
        script: |
          npm install

      - name: Install CocoaPods
        script: |
          cd ios
          pod install

      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles

      - name: Build iOS app
        script: |
          # Usa o primeiro arquivo encontrado na lista XCODE_PROJECT_OR_WORKSPACE
          if [ -d "ios/$XCODE_PROJECT_OR_WORKSPACE" ]; then
            PROJECT_PATH="ios/$XCODE_PROJECT_OR_WORKSPACE"
          elif [ -d "ios/modamaskavo.xcworkspace" ]; then
            PROJECT_PATH="ios/modamaskavo.xcworkspace"
          elif [ -f "ios/modamaskavo.xcodeproj/project.pbxproj" ]; then
            PROJECT_PATH="ios/modamaskavo.xcodeproj"
          else
            echo "Erro: Não foi encontrado .xcworkspace nem .xcodeproj na pasta ios/"
            exit 1
          fi

          xcode-project build-ipa \
            --project "$PROJECT_PATH" \
            --scheme "$XCODE_SCHEME"

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM

    publishing:
      # apple_app_store:
      #   api_key:
      #     id: Encrypted
      #     issuer_id: Encrypted
      #   track: TestFlight
      #   submit_for_review: false
      #   automatic_release: false
