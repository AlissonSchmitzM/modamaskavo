workflows:
  ios-workflow-debug-pods:
    name: iOS Build - Debug CocoaPods
    instance_type: mac_mini_m1
    environment:
      node: 18
      xcode: latest
    scripts:
      - name: Install npm dependencies
        script: |
          echo "ðŸ“¦ Instalando dependÃªncias npm..."
          npm install
          
      - name: Verificar estrutura antes do pod install
        script: |
          cd ios
          
          echo "ðŸ” Verificando estrutura antes do pod install..."
          
          # Verificar se Podfile existe
          if [ -f "Podfile" ]; then
            echo "âœ… Podfile encontrado"
            echo "ðŸ“„ ConteÃºdo do Podfile:"
            cat Podfile
          else
            echo "âŒ Podfile nÃ£o encontrado!"
            echo "ðŸ“ Arquivos na pasta ios:"
            ls -la
          fi
          
          # Verificar se jÃ¡ existe workspace
          if [ -f "modamaskavo.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âœ… Workspace jÃ¡ existe"
          else
            echo "â„¹ï¸  Workspace nÃ£o existe ainda (normal)"
          fi
          
      - name: Install CocoaPods com diagnÃ³stico
        script: |
          cd ios
          
          echo "ðŸ“¦ Instalando CocoaPods com diagnÃ³stico..."
          
          # Verificar se CocoaPods estÃ¡ instalado
          if ! command -v pod &> /dev/null; then
            echo "ðŸ“¦ Instalando CocoaPods..."
            gem install cocoapods
          else
            echo "âœ… CocoaPods jÃ¡ instalado"
            pod --version
          fi
          
          # Executar pod install com logs completos
          echo "ðŸ”¨ Executando pod install..."
          pod install --verbose 2>&1 | tee pod-install.log
          
          POD_RESULT=$?
          
          echo ""
          echo "ðŸ“Š Resultado do pod install: $POD_RESULT"
          
          if [ $POD_RESULT -eq 0 ]; then
            echo "âœ… pod install executado com sucesso!"
          else
            echo "âŒ pod install falhou!"
            echo "ðŸ” Ãšltimas linhas do log:"
            tail -30 pod-install.log
            
            echo ""
            echo "ðŸ” Procurando por erros especÃ­ficos:"
            grep -i "error" pod-install.log | head -5
            grep -i "could not" pod-install.log | head -5
            grep -i "unable" pod-install.log | head -5
          fi
          
      - name: Verificar o que foi criado
        script: |
          cd ios
          
          echo "ðŸ” Verificando o que foi criado apÃ³s pod install..."
          
          # Verificar workspace
          if [ -f "modamaskavo.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âœ… Workspace criado!"
          else
            echo "âŒ Workspace NÃƒO foi criado!"
            
            # Verificar se existe algum workspace
            WORKSPACES=$(find . -name "*.xcworkspace" -type d)
            if [ -n "$WORKSPACES" ]; then
              echo "ðŸ“ Workspaces encontrados:"
              echo "$WORKSPACES"
            else
              echo "âŒ Nenhum workspace encontrado!"
            fi
          fi
          
          # Verificar Podfile.lock
          if [ -f "Podfile.lock" ]; then
            echo "âœ… Podfile.lock criado!"
            echo "ðŸ“„ Primeiras linhas do Podfile.lock:"
            head -20 Podfile.lock
          else
            echo "âŒ Podfile.lock NÃƒO foi criado!"
          fi
          
          # Verificar pasta Pods
          if [ -d "Pods" ]; then
            echo "âœ… Pasta Pods criada!"
            echo "ðŸ“ ConteÃºdo da pasta Pods:"
            ls -la Pods/ | head -10
          else
            echo "âŒ Pasta Pods NÃƒO foi criada!"
          fi
          
          # Verificar se React foi instalado
          if [ -d "Pods/React-Core" ] || [ -d "Pods/React" ] || [ -d "Pods/RCT-Folly" ]; then
            echo "âœ… Componentes React encontrados!"
          else
            echo "âŒ Componentes React NÃƒO encontrados!"
            if [ -d "Pods" ]; then
              echo "ðŸ“ Pods disponÃ­veis:"
              ls -la Pods/ | grep -v "^d.*\.$"
            fi
          fi
          
      - name: Tentar corrigir problemas comuns
        script: |
          cd ios
          
          echo "ðŸ”§ Tentando corrigir problemas comuns..."
          
          # Se pod install falhou, tentar soluÃ§Ãµes
          if [ ! -f "modamaskavo.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âš ï¸  Workspace nÃ£o foi criado, tentando soluÃ§Ãµes..."
            
            # Limpar cache do CocoaPods
            echo "ðŸ§¹ Limpando cache do CocoaPods..."
            pod cache clean --all
            
            # Remover Pods e tentar novamente
            if [ -d "Pods" ]; then
              echo "ðŸ—‘ï¸  Removendo Pods existentes..."
              rm -rf Pods
            fi
            
            if [ -f "Podfile.lock" ]; then
              echo "ðŸ—‘ï¸  Removendo Podfile.lock..."
              rm -f Podfile.lock
            fi
            
            # Tentar pod install novamente
            echo "ðŸ”„ Tentando pod install novamente..."
            pod install --repo-update --verbose 2>&1 | tee pod-install-retry.log
            
            RETRY_RESULT=$?
            
            if [ $RETRY_RESULT -eq 0 ]; then
              echo "âœ… pod install funcionou na segunda tentativa!"
            else
              echo "âŒ pod install falhou novamente!"
              echo "ðŸ” Erros da segunda tentativa:"
              tail -20 pod-install-retry.log
            fi
          fi
          
      - name: Criar workspace manualmente se necessÃ¡rio
        script: |
          cd ios
          
          echo "ðŸ”§ Verificando se precisamos criar workspace manualmente..."
          
          if [ ! -f "modamaskavo.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âš ï¸  Criando workspace manualmente..."
            
            # Criar estrutura do workspace
            mkdir -p modamaskavo.xcworkspace
            
            # Criar contents.xcworkspacedata
            cat > modamaskavo.xcworkspace/contents.xcworkspacedata << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <Workspace
             version = "1.0">
             <FileRef
                location = "group:modamaskavo.xcodeproj">
             </FileRef>
             <FileRef
                location = "group:Pods/Pods.xcodeproj">
             </FileRef>
          </Workspace>
          EOF
            
            echo "âœ… Workspace criado manualmente!"
          else
            echo "âœ… Workspace jÃ¡ existe!"
          fi
          
      - name: Tentar build com o que temos
        script: |
          cd ios
          
          echo "ðŸ”¨ Tentando build com o que temos..."
          
          # Decidir se usar workspace ou project
          if [ -f "modamaskavo.xcworkspace/contents.xcworkspacedata" ]; then
            echo "ðŸ“± Usando workspace para build..."
            BUILD_TYPE="-workspace modamaskavo.xcworkspace"
          else
            echo "ðŸ“± Usando project para build..."
            BUILD_TYPE="-project modamaskavo.xcodeproj"
          fi
          
          mkdir -p build
          
          # Tentar build
          xcodebuild $BUILD_TYPE \
                     -scheme modamaskavo \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath build/modamaskavo.xcarchive \
                     archive \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     SKIP_INSTALL=NO \
                     ONLY_ACTIVE_ARCH=NO \
                     -allowProvisioningUpdates \
                     2>&1 | tee build-attempt.log
          
          BUILD_RESULT=$?
          
          echo ""
          echo "ðŸ“Š Resultado do build: $BUILD_RESULT"
          
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "âœ… Build funcionou!"
            
            # Verificar archive
            if [ -d "build/modamaskavo.xcarchive" ]; then
              echo "âœ… Archive criado!"
              
              # Procurar .app
              APP_PATH=$(find build/modamaskavo.xcarchive -name "*.app" -type d | head -1)
              
              if [ -n "$APP_PATH" ]; then
                echo "ðŸ“± App encontrado: $APP_PATH"
                
                # Criar IPA
                cd build
                cp -r "$APP_PATH" ./modamaskavo.app
                mkdir -p Payload
                cp -r modamaskavo.app Payload/
                zip -r modamaskavo.ipa Payload/
                
                if [ -f "modamaskavo.ipa" ]; then
                  IPA_SIZE=$(du -sh modamaskavo.ipa | cut -f1)
                  echo "âœ… IPA criado: $IPA_SIZE"
                  cp modamaskavo.ipa ../../modamaskavo-debug.ipa
                fi
              fi
            fi
          else
            echo "âŒ Build falhou!"
            echo "ðŸ” Ãšltimas linhas do erro:"
            tail -20 build-attempt.log
          fi
          
      - name: RelatÃ³rio de diagnÃ³stico
        script: |
          echo "ðŸ“‹ RELATÃ“RIO DE DIAGNÃ“STICO"
          echo "=========================="
          
          cd ios
          
          echo "ðŸ“Š Status dos arquivos:"
          echo "- Podfile: $([ -f "Podfile" ] && echo "âœ…" || echo "âŒ")"
          echo "- Podfile.lock: $([ -f "Podfile.lock" ] && echo "âœ…" || echo "âŒ")"
          echo "- Workspace: $([ -f "modamaskavo.xcworkspace/contents.xcworkspacedata" ] && echo "âœ…" || echo "âŒ")"
          echo "- Pasta Pods: $([ -d "Pods" ] && echo "âœ…" || echo "âŒ")"
          
          echo ""
          echo "ðŸ“± IPAs encontrados:"
          find .. -name "*.ipa" -exec ls -lh {} \;
          
          echo ""
          echo "ðŸ“„ Logs disponÃ­veis:"
          ls -la *.log 2>/dev/null || echo "Nenhum log encontrado"
          
    artifacts:
      - ios/pod-install.log
      - ios/pod-install-retry.log
      - ios/build-attempt.log
      - ios/Podfile.lock
      - ios/build/*.ipa
      - ios/build/*.app
      - ios/build/*.xcarchive
      - "*.ipa"
